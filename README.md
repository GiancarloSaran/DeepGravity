# A Deep Gravity model for mobility flows generation

a PyTorch implementation of the paper: 
```
F. Simini, G. Barlacchi, M. Luca, L. Pappalardo, 
Deep Gravity: enhancing mobility flows generation with deep neural networks and geographic information
https://arxiv.org/abs/2012.00489
```

Please cite the paper:
```
@misc{simini2021deep,
      title={Deep Gravity: enhancing mobility flows generation with deep neural networks and geographic information}, 
      author={Filippo Simini and Gianni Barlacchi and Massimiliano Luca and Luca Pappalardo},
      year={2021},
      eprint={2012.00489},
      archivePrefix={arXiv},
      primaryClass={cs.LG}
}
```

and the code: [![DOI](https://zenodo.org/badge/379271033.svg)](https://zenodo.org/badge/latestdoi/379271033)


## Abstract
The movements of individuals within and among cities influence critical aspects of our society, such as well-being, the spreading of epidemics, and the quality of the environment. When information about mobility flows is not available for a particular region of interest, we must rely on mathematical models to generate them.

**Deep Gravity** is an effective method to generate flow probabilities that exploits many variables (e.g., land use, road network, transport, food, health facilities) extracted from voluntary geographic data, and uses deep neural networks to discover non-linear relationships between those variables and mobility flows. 

Our experiments, conducted on mobility flows in England, Italy, and New York State, show that Deep Gravity has good geographic generalization capability, achieving a significant increase in performance (especially in densely populated regions of interest) with respect to the classic gravity model and models that do not use deep neural networks or geographic data. We also show how flows generated by Deep Gravity may be explained in terms of the geographic features using explainable AI techniques.

![Performances of DG vs G in an highly populated area in England](https://github.com/scikit-mobility/DeepGravity/blob/master/imgs/plot.png?raw=true)
_Figure 1. Performances in terms of Common Part of Commuters (CPC) of Deep Gravity (DG) vs the gravity model (G) in an highly populated area in England_

## Setup

Please, make sure you have the following dependencies installed:

- `pytorch 1.7.1`
- `numpy 1.19.2`
- `pandas 1.2.4`
- `geopandas 0.9.0`
- `scikit-mobility 1.1.0`
- `area`

## Running Deep Gravity

Once you installed all the packages correctly, you can run the experiments.

We expect to find some datasets in a path named `data/<country_name>` where country name is a parameter that can be passed to the model. In particular, we expect to find:

- `tessellation.geojson` or `tessellation.shp`. The tessellation can also be generated by using the parameters `tessellation-area` and `tessellation-size` when the model is called.
- `output_areas.geojson` or `output_areas.shp`. A file containing the location code and the geometry of the output areas. the column containing the location code can be specified using the parameter `oa-id-column` when calling the model.
- `flows.csv` containing three columns indicating the origin, destination and the actual flow of people. The columns with the information can be called specifying the parameters `flow-origin-column`, `flow-destination-column` and `flow-flows-column`
- `features.csv` containing at least a column named like `oa-id-column` and a set of other columns representing the features of the model

An example of dataset collected in New York is already loaded in the repository and the following examples are based on that.

The model can be run with the following command:

`python main.py --dataset new_york --oa-id-column GEOID --flow-origin-column geoid_o --flow-destination-column geoid_d --flow-flows-column pop_flows --epochs 1 --device cpu --mode train`

you can also include some parameters related to the model:

- `batch-size` to specify the input batch size for training. Deafult is 1 
- `test-batch-size` to specify the batch size at test time. Default is 1
- `epochs` default is 10 
- `lr` that is the learning rate. Default is 5e-6 
- `momentum`  default is 0.9
- `seed` 
- `device` can be `cpu` or `gpu` 
- `mode` that can be `train` or `test` 

There are also some parameters related to the 

Once your model is trained, you will find the results of the test phase in a file in the results directory. The file will be named `tile2cpc_<model-type>_<country>_<no-round>.csv`. In the same folder, you will also find the trained model named `model_<model-type>_<country>_<no-round>.pt`

## Plot of the results

Once you have the results for all the four models in at least a country and at least for one no-round, you can reproduce Figure 3 and Table 1 of the paper using the notebook `plot_results.ipynb`

## Additional Data

The datasets used in the experiments can be found at:
- England
  - [https://census.ukdataservice.ac.uk/use-data/guides/flow-data.aspx](https://census.ukdataservice.ac.uk/use-data/guides/flow-data.aspx)
  - [https://census.ukdataservice.ac.uk/use-data/guides/boundary-data](https://census.ukdataservice.ac.uk/use-data/guides/boundary-data)
- Italy
  - [http://datiopen.istat.it/datasetPND.php](http://datiopen.istat.it/datasetPND.php)
  - [https://www.istat.it/it/archivio/104317#accordions](https://www.istat.it/it/archivio/104317#accordions)
- New York
  - [https://github.com/GeoDS/COVID19USFlows](https://github.com/GeoDS/COVID19USFlows)
  - [https://www.census.gov/cgi-bin/geo/shapefiles/index.php?year=2020&layergroup=Census+Tracts](https://www.census.gov/cgi-bin/geo/shapefiles/index.php?year=2020&layergroup=Census+Tracts)

Data related to POIs should be retrieved from appropriate services. Examples are Overpass API, HOTosm or - suggested - by downloading a local copy of the OSM database in a PostgreSQL instance and by running appropriate queries. The query we used to retrieved POIs information is available in `osm_query.yaml`
