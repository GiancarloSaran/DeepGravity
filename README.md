# A Deep Gravity model for mobility flows generation

## Table of contents
1. [Citing](#citing)
2. [Abstract](#abstract)
3. [Setup](#setup)
4. [Running Deep Gravity](#running)
5. [Plot the results](#plot)
6. [Additional data](#additional_data)


<a id='citing'></a>
## Citing

If you use the code in this repository, please cite our paper:

```
Simini, F., Barlacchi, G., Luca, M., Pappalardo, L., A Deep Gravity model for mobility flows generation. 
Nature Communications 12, 6576 (2021). https://doi.org/10.1038/s41467-021-26752-4
```

```
@article{Simini2021,
author = {Simini, Filippo and Barlacchi, Gianni and Luca, Massimilano and Pappalardo, Luca},
doi = {10.1038/s41467-021-26752-4},
issn = {2041-1723},
journal = {Nature Communications},
number = {1},
pages = {6576},
title = {{A Deep Gravity model for mobility flows generation}},
url = {https://doi.org/10.1038/s41467-021-26752-4},
volume = {12},
year = {2021}}
```

and the official code repository: [![DOI](https://zenodo.org/badge/379271033.svg)](https://zenodo.org/badge/latestdoi/379271033)

<a id='abstract'></a>
## Abstract
The movements of individuals within and among cities influence critical aspects of our society, such as well-being, the spreading of epidemics, and the quality of the environment. When information about mobility flows is not available for a particular region of interest, we must rely on mathematical models to generate them. We propose Deep Gravity, an effective model to generate flow probabilities that exploits many features (e.g., land use, road network, transport, food, health facilities) extracted from voluntary geographic data, and uses deep neural networks to discover non-linear relationships between those features and mobility flows. Our experiments, conducted on mobility flows in England, Italy, and New York State, show that Deep Gravity achieves a significant increase in performance, especially in densely populated regions of interest, with respect to the classic gravity model and models that do not use deep neural networks or geographic data. Deep Gravity has good generalization capability, generating realistic flows also for geographic areas for which there is no data availability for training. Finally, we show how flows generated by Deep Gravity may be explained in terms of the geographic features and highlight crucial differences among the three considered countries interpreting the modelâ€™s prediction with explainable AI techniques.

![Performances of DG vs G in an highly populated area in England](https://github.com/scikit-mobility/DeepGravity/blob/master/imgs/plot.png?raw=true)
_Figure 1. Performances in terms of Common Part of Commuters (CPC) of Deep Gravity (DG) vs the gravity model (G) in an highly populated area in England_

<a id='setup'></a>
## Setup

Please, make sure you have the following dependencies installed:

- `pytorch 1.7.1`
- `numpy 1.19.2`
- `pandas 1.2.4`
- `geopandas 0.9.0`
- `scikit-mobility 1.1.0`
- `area`

<a id='running'></a>
## Running Deep Gravity

Once you installed all the packages correctly, you can run the experiments.

We expect to find some datasets in a path named `data/<country_name>` where country name is a parameter that can be passed to the model. In particular, we expect to find:

- `tessellation.geojson` or `tessellation.shp`. The tessellation can also be generated by using the parameters `tessellation-area` and `tessellation-size` when the model is called.
- `output_areas.geojson` or `output_areas.shp`. A file containing the location code and the geometry of the output areas. the column containing the location code can be specified using the parameter `oa-id-column` when calling the model.
- `flows.csv` containing three columns indicating the origin, destination and the actual flow of people. The columns with the information can be called specifying the parameters `flow-origin-column`, `flow-destination-column` and `flow-flows-column`. Due to GitHub policy, the file containing the flows for the running example of New York have to be downloaded from [here](here)
- `features.csv` containing at least a column named like `oa-id-column` and a set of other columns representing the features of the model

An example of dataset collected in New York is already loaded in the repository and the following examples are based on that. Note that when main.py is launched for the first time, a set of additional files are generated in a folder called `processed`. These files should not be removed.

The model can be run with the following command:

`python main.py --dataset new_york --oa-id-column GEOID --flow-origin-column geoid_o --flow-destination-column geoid_d --flow-flows-column pop_flows --epochs 1 --device cpu --mode train`

you can also include some parameters related to the model:

- `batch-size` to specify the input batch size for training. Deafult is 1 
- `test-batch-size` to specify the batch size at test time. Default is 1
- `epochs` default is 10 
- `lr` that is the learning rate. Default is 5e-6 
- `momentum`  default is 0.9
- `seed` 
- `device` can be `cpu` or `gpu` 
- `mode` that can be `train` or `test` 

There are also some parameters related to the 

Once your model is trained, you will find the results of the test phase in a file in the results directory. The file will be named `tile2cpc_<model-type>_<country>_<no-round>.csv`. In the same folder, you will also find the trained model named `model_<model-type>_<country>_<no-round>.pt`

<a id='plot'></a>
## Plot of the results

Once you have the results for all the four models in at least a country and at least for one no-round, you can reproduce Figure 3 and Table 1 of the paper using the notebook `plot_results.ipynb`

<a id='additional_data'></a>
## Additional Data

The datasets used in the experiments can be found at:
- England
  - [https://census.ukdataservice.ac.uk/use-data/guides/flow-data.aspx](https://census.ukdataservice.ac.uk/use-data/guides/flow-data.aspx)
  - [https://census.ukdataservice.ac.uk/use-data/guides/boundary-data](https://census.ukdataservice.ac.uk/use-data/guides/boundary-data)
- Italy
  - [http://datiopen.istat.it/datasetPND.php](http://datiopen.istat.it/datasetPND.php)
  - [https://www.istat.it/it/archivio/104317#accordions](https://www.istat.it/it/archivio/104317#accordions)
- New York
  - [https://github.com/GeoDS/COVID19USFlows](https://github.com/GeoDS/COVID19USFlows)
  - [https://www.census.gov/cgi-bin/geo/shapefiles/index.php?year=2020&layergroup=Census+Tracts](https://www.census.gov/cgi-bin/geo/shapefiles/index.php?year=2020&layergroup=Census+Tracts)

Data related to POIs should be retrieved from appropriate services. Examples are Overpass API, HOTosm or - suggested - by downloading a local copy of the OSM database in a PostgreSQL instance and by running appropriate queries. The query we used to retrieved POIs information is available in `osm_query.yaml`
